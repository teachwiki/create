window.DirectUPL={signReq:null,uploadReq:null,parseXml:function(a){return new window.DOMParser().parseFromString(a,"text/xml")},postToJAJ:function(o,n,m,l,p){try{var b=new XMLHttpRequest();window.DirectUPL.signReq=b;b.onload=function(){try{b.upload.removeEventListener("error",h);b.upload.removeEventListener("abort",a)}catch(e){}if(window.DirectUPL.signReq==null){return}window.DirectUPL.signReq=null;try{var d=(b.response!=null)?b.response:b.responseText;m(d)}catch(e){}b=null};var a=function(){try{b.upload.removeEventListener("error",h);b.upload.removeEventListener("abort",a)}catch(d){}if(window.DirectUPL.signReq==null){return}window.DirectUPL.signReq=null;try{if(p!=null){p("abort")}}catch(d){}b=null};var h=function(e){try{b.upload.removeEventListener("error",h);b.upload.removeEventListener("abort",a)}catch(d){}if(window.DirectUPL.signReq==null){return}window.DirectUPL.signReq=null;try{var f=(e!=null&&(typeof e==="string"||e instanceof String))?e:null;if(f==null){if(b&&b.status){f="Status: "+b.status}if(b&&b.statusText){if(f==null){f="Status Text: "+b.statusText}else{f+=", "+b.statusText}}}if(b&&(b.response||b.responseText)){if(f==null){f=""}f+=" Response: "+((b.response!=null)?b.response:b.responseText)}if(e&&e.type){if(f==null){f=""}f+=" Type: "+e.type}console.log("DPL_SIG err log: "+f)}catch(d){}try{if(p!=null){p("error")}}catch(d){}b=null};var k="";if(typeof n==="object"){var j=0;for(var q in n){if(j>0){k+="&"}j++;k+=q+"="+n[q]}}else{k=n}try{b.upload.addEventListener("error",h);b.upload.addEventListener("abort",a);b.withCredentials=true;b.open("POST",o,true);b.setRequestHeader("Content-Type","application/x-www-form-urlencoded");try{b.setRequestHeader("X-CSRF-Token",getCsToken())}catch(c){}b.send(k)}catch(c){}}catch(c){}},upload:function(j,d){var l=new XMLHttpRequest();window.DirectUPL.uploadReq=l;var f=0;var k=null;var e=function(o){if(window.DirectUPL.uploadReq==null){return}if(f==0&&typeof h!=="undefined"){f=1;if(r){try{r.upload.removeEventListener("error",e);r.upload.removeEventListener("abort",g);r=null}catch(n){}var r=new XMLHttpRequest();window.DirectUPL.uploadReq=r}setTimeout(function(){h(k)},111);return}window.DirectUPL.uploadReq=null;try{try{var q=(o!=null&&(typeof o==="string"||o instanceof String))?o:null;if(q==null){if(r&&r.status){q="Status: "+r.status}if(r&&r.statusText){if(q==null){q="Status Text: "+r.statusText}else{q+=", "+r.statusText}}}if(r&&(r.response||r.responseText)){if(q==null){q=""}q+=" Response: "+((r.response!=null)?r.response:r.responseText)}if(o&&o.type){if(q==null){q=""}q+=" Type: "+o.type}console.log("S3 Error log: "+q)}catch(n){}Sentry.captureException(new Error("S3 error: transfer failed"))}catch(p){}try{m()}catch(n){}j({error:1})};var g=function(o){if(window.DirectUPL.uploadReq==null){return}window.DirectUPL.uploadReq=null;try{m()}catch(n){}j({abort:1})};var m=function(){try{l.upload.removeEventListener("error",e);l.upload.removeEventListener("abort",g)}catch(n){}l=null};function h(o){if(window.DirectUPL.uploadReq==null){return}k=o;try{o=JSON.parse(o)}catch(n){}if(o&&o!=""&&o.data&&o.data.url&&o.data.inputs){var p=new FormData();Object.keys(o.data.inputs).forEach(function(q){p.append(q,o.data.inputs[q])});p.append("file",d.blob);l.onload=function(){if(window.DirectUPL.uploadReq==null){return}window.DirectUPL.uploadReq=null;var v=null;try{v=(l.response!=null)?l.response:((l.responseText!=null)?responseText:l.responseXML)}catch(s){}try{m()}catch(s){}if(v!=null){var t=null;try{t=window.DirectUPL.parseXml(v)}catch(s){j({error:1});return}if(t!=null){var r=null;try{r=t}catch(s){j({error:1});return}var q=0;try{q=r.getElementsByTagName("Location")[0].childNodes[0].nodeValue.length}catch(s){}if(r!=null&&q>0){var w={url:r.getElementsByTagName("Location")[0].childNodes[0].nodeValue.replace("%2F","/"),s3_name:r.getElementsByTagName("Key")[0].childNodes[0].nodeValue};j(w)}else{try{console.log("S3 returned",v)}catch(u){}try{Sentry.captureException(new Error("S3 error: uploaded Xml null"))}catch(u){}j({error:1})}}else{try{Sentry.captureException(new Error("S3 error: response xml doc parsing"))}catch(u){}j({error:1})}}else{try{Sentry.captureException(new Error("S3 error: response null"))}catch(u){}j({error:1})}};try{l.upload.addEventListener("error",e);l.upload.addEventListener("abort",g);l.open("POST",o.data.url,true);l.send(p)}catch(n){}}else{j({error:1})}}var b=function(o){if(o=="abort"){j({abort:1})}else{try{Sentry.captureException(new Error("DPL_SIG error: "+o))}catch(p){try{console.error("DPL_SIG: "+o)}catch(n){}}j({error:1})}};var c=(typeof window.BeFunky!=="undefined")?window.BeFunky.Params.siteUrl+"api/direct-upload/":"https://upload.befunky.com/direct_upl.php";var a=getCsToken();var i="bucket="+d.bucket+"&content_type="+d.content_type+"&CSRFtoken="+a;if(d.filename&&d.filename!=null){i=i+"&filename="+d.filename}window.DirectUPL.postToJAJ(c,i,h,"json",function(n){if(n=="abort"){j({abort:1})}else{j({abort:1})}})}};